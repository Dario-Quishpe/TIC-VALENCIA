---
title: "ANALISIS EXPLORATORIO TIC DE LOS DATOS"
author: "Dario Quishpe"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(readxl)
library(sf)
library(leaflet)
library(deldir)
library(spatstat)
library(tsibble)
library(tseries)

library(fpp3)
library(forecast)
library(fpp2)
library(TSA)
library(grid)
pacman::p_load(tidyverse,sf,mapview)
```

### Estadistica descriptiva de los datos  


```{r}
base<-read.csv("obs_data_112Valencia (1).csv")
base<-base |> filter(year<=2019)
head(base$crime_date)
tail(base$crime_date)
base
#view(base)
```



```{r}
(summary(base))
str(base)

```

```{r}
apply(is.na(base), 2, mean)
```
```{r}
BASE<-read.csv("obs_data_112Valencia (1).csv", sep=",", header=TRUE) 
puntos<-BASE|>filter(year<=2019) |> st_as_sf(coords=c("crime_lon","crime_lat"),crs= 4258)

#mapview(puntos, map.types = "CartoDB.Voyager")

puntos
```
```{r}


ventana_sin_z <- st_zm(ventana)
barrio<- st_read("barris-barrios/barris-barrios.shp",quiet=TRUE)
barrio<-barrio |> filter(coddistbar=="112")
#barrio <- st_transform(barrio, crs = st_crs("EPSG:32630"))
barrio_sin_z <- st_zm(barrio)
# Crear el mapa
mapa <- leaflet() %>%
  addTiles() %>%addPolygons(data = ventana_sin_z,
  opacity = 1,
  color = "black",
  dashArray = "3",
  fillOpacity = 0.2, weight = 5)
  
mapa
```


```{r}


ventana_sin_z <- st_zm(ventana)
barrio<- st_read("barris-barrios/barris-barrios.shp",quiet=TRUE)
barrio<-barrio |> filter(coddistbar=="112")
#barrio <- st_transform(barrio, crs = st_crs("EPSG:32630"))
barrio_sin_z <- st_zm(barrio)
# Crear el mapa
mapa <- leaflet() %>%
  addTiles() %>%
  addCircleMarkers(data = puntos, color = "#2DBCFA", radius = 0.01)

# Agregar los límites de la ciudad al mapa
mapa1 <- mapa %>% addPolygons(data = ventana_sin_z,
  opacity = 1,
  color = "black",
  dashArray = "3",
  fillOpacity = 0.2, weight = 5)

mapa1
```

```{r}
ventana_sin_z <- st_zm(ventana)
barrio<- st_read("barris-barrios/barris-barrios.shp",quiet=TRUE)
barrio<-barrio |> filter(coddistbar=="112")
#barrio <- st_transform(barrio, crs = st_crs("EPSG:32630"))
barrio_sin_z <- st_zm(barrio)
# Crear el mapa
mapa <- leaflet() %>%
  addTiles() %>%
  addCircleMarkers(data = puntos, color = "#2DBCFA", radius = 0.05)

# Agregar los límites de la ciudad al mapa
mapa1 <- mapa %>% addPolygons(data = ventana_sin_z,
  opacity = 1,
  color = "white",
  dashArray = "3",
  fillOpacity = 0.2, weight = 5)

mapa2<-mapa1 |> addPolygons(data = barrio_sin_z,
  opacity = 1,
  color = "red",
  dashArray = "3",
  fillOpacity = 0.5,   weight = 6) 

# Visualizar el mapa
mapa2
```

```{r}

```

```{r}
#DIVISIONES DE DISTRTOS ORIGINALES 
#library(sf)
ventana <- st_read("shape files-20221031T083303Z-001/shape files/valencia_outline.shp",quiet=TRUE)
y <- st_read("shape files-20221031T083303Z-001/shape files/valencia_road.shp",quiet=TRUE)

#ggplot()+geom_sf(data = x)+geom_sf(data = y)+geom_sf(data = puntos,aes())+scale_x_continuous()
#y<-st_read("ca_municipios_20231105/ca_municipios_20231105.shp")
#view(x)
#ggplot() + geom_sf(data = x, fill="darkseagreen")
#x <- st_read("drive-download-20231208T164315Z-001/ecuador.shp",quiet=TRUE)
#ventana<-x |> filter(NOMBRE=="VALENCIA")  

#Filtro de base para presentar datos espaciales 
  
puntos_grafica<-puntos 
dim(puntos_grafica)
dim(puntos)
ggplot()+geom_sf(data = ventana,color="black",size=5)+geom_sf(data = y,color="#435962")+geom_sf(data = puntos_grafica,aes(),size=0.1,color="#2DBCFA")+scale_x_continuous()
ggplot()+geom_sf(data = ventana,color="black",size=2)+geom_sf(data = y,color="#435962")+geom_sf(data = puntos_grafica,aes(),size=0.1,color="#2DBCFA")+facet_wrap(~crime_type)+
        theme(axis.text.x = element_text(angle =90, vjust = 0.5, hjust = 1),strip.background = element_rect(fill = "lightblue"))


```
```{r}

#tablita de frecuencias 
tabla<-base |> group_by(crime_type) |> summarise(Tot=n()) |> 
            mutate(Porcentaje=round(Tot/sum(Tot)*100,2))

ggplot(tabla,aes(x=crime_type,y=Tot))+ geom_bar(color="black",fill="#40D6FA",width = 0.9, stat="identity", position = position_dodge())+
             ylim(c(0,75000))+
            labs(x="Tipo de delitos", y= "Número de delitos") +   
            labs(fill = "")+  
            geom_text(aes(label=paste0(Tot," ", "", "(", Porcentaje, "%",")")),    
            vjust=-0.9, 
            color="black", 
            hjust=0.5,
            position = position_dodge(0.9),  
            angle=0, 
            size=4.0
            ) 

```

```{r}
st<-base |> mutate(crime_date=as.Date(crime_date,format = "%m/%d/%Y"))
stmy<-st |>mutate(anio_mes=format(crime_date,"%Y-%m")) |> 
        group_by(anio_mes) |> summarise(Numero_de_Registros=n())

stmy$Tiempo <-yearmonth(stmy$anio_mes)
ST<-stmy |>  as_tsibble(index = Tiempo) |> select(Tiempo,Numero_de_Registros)
ST %>%
  autoplot() +
  geom_point(color = "black") +  
  geom_line(color = "blue") +  
  ggtitle("
          Número de registros por mes") +  # Establecer título
  theme_bw()  
```


