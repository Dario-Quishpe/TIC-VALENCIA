---
title: "EXPLORANDO_TIC"
author: "Dario Quishpe"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

```{r}
library(tidyverse)
library(readxl)
library(sf)
library(leaflet)
library(deldir)
library(spatstat)
#install.packages("tigris")
library(tigris)
library(spatstat.geom)
library(spatstat.linnet)
#install.packages("spNetwork")
library(spNetwork)
library(sp)
library(maps)
library(stars)
library(terra)
install.packages("sfnetworks")
library(sfnetworks)
#install.packages("PBSmapping")
library(PBSmapping)
pacman::p_load(tidyverse,sf,mapview)
```
```{r}
BASE<-read.csv("obs_data_112Valencia (1).csv", sep=",", header=TRUE)
dim(BASE)
BASE<-BASE |> filter(year==2019)
dim(BASE)
```

```{r}
BASE<-read.csv("obs_data_112Valencia (1).csv", sep=",", header=TRUE) 
puntos<-BASE|>filter(year==2019) |>  
  st_as_sf(coords=c("crime_lon","crime_lat"),crs= 4258)

#mapview(puntos, map.types = "CartoDB.Voyager")

puntos
```

```{r}
#ANALISIS EXPLORATORIO 
ventana <- st_read("shape files-20221031T083303Z-001/shape files/valencia_outline.shp",quiet=TRUE)
y <- st_read("shape files-20221031T083303Z-001/shape files/valencia_road.shp",quiet=TRUE)

#ggplot()+geom_sf(data = x)+geom_sf(data = y)+geom_sf(data = puntos,aes())+scale_x_continuous()
#y<-st_read("ca_municipios_20231105/ca_municipios_20231105.shp")
#view(x)
#ggplot() + geom_sf(data = x, fill="darkseagreen")
#x <- st_read("drive-download-20231208T164315Z-001/ecuador.shp",quiet=TRUE)
#ventana<-x |> filter(NOMBRE=="VALENCIA")  
ggplot()+geom_sf(data = ventana)+geom_sf(data = y,color="blue")+geom_sf(data = puntos,aes(),size=0.2,color="#D9DC4C")+scale_x_continuous()
ggplot()+geom_sf(data = ventana)+geom_sf(data = y,color="blue")+geom_sf(data = puntos,aes(),size=0.2,color="#D9DC4C")+facet_wrap(~crime_type)+
        theme(axis.text.x = element_text(angle =90, vjust = 0.5, hjust = 1),strip.background = element_rect(fill = "lightblue"))


```






```{r}

#OBTENIENDO VENTANITA

ventana<- st_read("shape files-20221031T083303Z-001/shape files/valencia_outline.shp",quiet=TRUE)
ventana1 <- st_transform(ventana, crs = st_crs("EPSG:32630"))
ventana2<-st_union(ventana1[1])
window<-st_coordinates(st_reverse(ventana2[1]))
a<-st_coordinates(st_reverse(ventana2[1]))
window<-owin(poly=a[,c("X","Y")])
plot(window)

```


```{r}


#Cumpliendo con el criterio : el 30$ de ceros sea menor  al 30%
grid <- ventana1%>%
  st_make_grid(n = c(17,18)) %>%
  st_intersection(ventana1) %>% 
   st_cast("MULTIPOLYGON") %>%
  st_sf()
plot(grid)
puntos <- st_transform(puntos, crs = st_crs(grid))

inter <- st_intersects(grid, puntos)
grid$count <- lengths(inter)
ggplot(grid) + geom_sf(aes(fill = count))


ggplot(grid) + geom_sf(aes(fill = count))+
scale_fill_continuous(type = "viridis")



grid.selec <- grid
ggplot(grid.selec) + geom_sf(aes(fill = count))+
geom_sf_text(aes(label = count), size = 2, color = "white")+
scale_fill_continuous(type = "viridis") +
theme(
  axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
  axis.title.x = element_blank(),
  axis.title.y = element_blank())
```
```{r}

#dejando fuera cuadrantes con 0  observaciones
grid <- ventana1%>%
  st_make_grid(n = c(40,40)) %>%
  st_intersection(ventana1) %>% 
   st_cast("MULTIPOLYGON") %>%
  st_sf()
plot(grid)
puntos <- st_transform(puntos, crs = st_crs(grid))

inter <- st_intersects(grid, puntos)
grid$count <- lengths(inter)
ggplot(grid) + geom_sf(aes(fill = count))


ggplot(grid) + geom_sf(aes(fill = count))+
scale_fill_continuous(type = "viridis")



grid.selec <- grid[grid$count>0, ]
ggplot(grid.selec) + geom_sf(data = ventana,fill="#A3E3FF")+geom_sf(aes(fill = count))+
geom_sf_text(aes(label = count), size = 2, color = "white")+
scale_fill_continuous(type = "viridis") +
theme(
  axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
  axis.title.x = element_blank(),
  axis.title.y = element_blank())
```




```{r}
target_crs <- st_crs("+proj=utm +zone=30 +north +datum=WGS84 +units=m +no_defs")
a_sf_reprojected <- st_transform(puntos, target_crs)

app <- ppp( x = st_coordinates(a_sf_reprojected)[,1],
            y = st_coordinates(a_sf_reprojected)[,2],
            marks = c(1:10929),
            window = window)

plot(app)

#app<-rjitter(app, retry = TRUE, nsim = 1, drop = TRUE)

unique(app)
unique(app, rule="deldir")
options(repr.plot.width = 50, repr.plot.height = 30)
plot(quadratcount(app, nx = 17, ny = 18))
quadrat.test(app, nx = 17, ny = 18)


```

```{r}

#Estimaciones de sigma 
estimacion1<-bw.diggle(app)
estimacion2<-bw.ppl(app)
estimacion3<-bw.scott(app)
plot(density.ppp(app,sigma = estimacion1,edge = T),main=paste("Diggle"))
plot(density.ppp(app,sigma = estimacion2,edge = T),main=paste("LH-crossvalidation"))
plot(density.ppp(app,sigma = estimacion3[1],edge = T),main=paste("Scott1"))
plot(density.ppp(app,sigma = estimacion3[2],edge = T),main=paste("Scott2"))
estimacion3[1]
```

```{r}
kernel_density <- density(app,403.7447 )
summary(kernel_density)
plot(kernel_density)
```


```{r}
K_function <- Kest(app)
summary(K_function)
plot(K_function, main = "Función K(r) homogeneo")

K_functioninom <- Kinhom(app)
summary(K_functioninom)
plot(K_functioninom, main = "Función K(r) no homogeneo")
```
```{r}
g_function <- Ginhom(app)
summary(g_function)
plot(g_function, main = "Función G(r)) no homogeneo")
```
```{r}
g_function <- Gest(app)
summary(g_function)
plot(g_function, main = "Función G(r)) homogeneo")
```

```{r}
L_function <-Lest(app)
summary(L_function)
plot(L_function, main = "Función L(r) homogeneo")

L_functioninom <-Linhom(app)
summary(L_functioninom)
plot(L_functioninom, main = "Función L(r) no homogeneo")



```


```{r}
plot(density(app, 278.5927),  main = "0.5 x the default bandwidth")
points(app, col="#00BA4C", pch=19,cex=0.05)
```
# Analisis en redes - ESTIMACION DEL KERNEL , Y FUNCION K DE RIPLEY 

```{r}
#puntos <- st_transform(puntos, crs = st_crs(grid))
y<-st_transform(y, crs = st_crs(puntos))


kfun_theatre <- kfunctions(y, puntos,
                           start = 0, end = 10000, step = 1000, 
                           width = 2000, nsim = 3,
                            conf_int = 0.05,agg = 400)
kfun_theatre$plotk
kfun_theatre$plotg

```





```{r}
library(spNetwork)
library(tmap)

data(main_network_mtl)
data(mtl_libraries)
data(mtl_theatres)

tm_shape(main_network_mtl) + 
  tm_lines("black") + 
  tm_shape(mtl_libraries) + 
  tm_dots(col = "red", size = 0.2) +
  tm_shape(mtl_theatres) + 
  tm_dots(col = "blue", size = 0.2)
```
```{r}
kfun_biblio <- kfunctions(main_network_mtl, mtl_libraries,
                          start = 0, end = 5000, step = 50,
                          width = 1000, nsim = 50, verbose = FALSE)

kfun_biblio$plotk
```
```{r}
y <- st_read("shape files-20221031T083303Z-001/shape files/valencia_road.shp",quiet=TRUE)
y <- st_transform(y, crs = "+proj=utm +zone=30 +datum=WGS84")

# Convertir a un objeto de red
vias <- as_sfnetwork(y)

# Convertir a un objeto linnet

vias <- as.linnet(vias)
plot(vias)
target_crs <- st_crs("+proj=utm +zone=30 +north +datum=WGS84 +units=m +no_defs")
a_sf_reprojected <- st_transform(puntos, target_crs)

lpp_VALE <- lpp(app,L = vias )
```

