---
title: "LPP_CABANYAL"
author: "Dario Quishpe"
date: "`r Sys.Date()`"
output: html_document
---


```{r}
library(tidyverse)
library(readxl)
library(sf)
library(leaflet)
library(deldir)
library(spatstat)
#install.packages("tigris")
library(tigris)
library(spatstat.geom)
library(spatstat.linnet)
#install.packages("spNetwork")
library(spNetwork)
library(sp)
library(maps)
library(stars)
library(terra)
#install.packages("sfnetworks")
library(sfnetworks)
#install.packages("PBSmapping")
library(PBSmapping)
library(tmap)
pacman::p_load(tidyverse,sf,mapview)
```

```{r}
BASE<-read.csv("obs_data_112Valencia (1).csv", sep=",", header=TRUE)
dim(BASE)
BASE<-BASE |> filter(year<=2019) 
dim(BASE)
head(BASE)
```


```{r}
BASE<-read.csv("obs_data_112Valencia (1).csv", sep=",", header=TRUE) 
puntos<-BASE|>filter(year<=2019) |> 
  st_as_sf(coords=c("crime_lon","crime_lat"),crs= 4258)

#mapview(puntos, map.types = "CartoDB.Voyager")

puntos

ventana <- st_read("shape files-20221031T083303Z-001/shape files/valencia_outline.shp",quiet=TRUE)
y <- st_read("shape files-20221031T083303Z-001/shape files/valencia_road.shp",quiet=TRUE)
```


```{r}
#NO HACER CORRER EL CODIGO CON GRID .....
y<-st_transform(y, crs = st_crs(puntos))
barrio<-st_read("barris-barrios/barris-barrios.shp",quiet=TRUE)
#plot(barrio)
a<-"112"
#y<-st_transform(y, crs = st_crs(puntos))
barrio<-st_read("barris-barrios/barris-barrios.shp",quiet=TRUE)
barrio<-barrio |> filter(coddistbar==a)
barrio<-st_transform(barrio, crs = st_crs(puntos))
interseccion<-st_intersection(y,barrio)
plot(interseccion)
puntos <- st_transform(puntos,st_crs(barrio))
puntos_barrio<-st_intersection(puntos,barrio)
plot(puntos_barrio)
calles_barrio<- interseccion[st_geometry_type(interseccion) == "LINESTRING", ]

```

```{r}
tm_shape(calles_barrio) + 
  tm_lines("black") + 
  tm_shape(puntos_barrio) + 
  tm_dots(col = "blue", size = 0.2)
```


```{r}
ventana<- st_read("barris-barrios/barris-barrios.shp",quiet=TRUE)
ventana<-ventana |> filter(coddistbar==a)
ventana1 <- st_transform(ventana, crs = st_crs("EPSG:32630"))
ventana2<-st_union(ventana1[1])
window<-st_coordinates(st_reverse(ventana2[1]))
a<-st_coordinates(st_reverse(ventana2[1]))
window<-owin(poly=a[,c("X","Y")])
plot(window)



target_crs <- st_crs("+proj=utm +zone=30 +north +datum=WGS84 +units=m +no_defs")
a_sf_reprojected <- st_transform(puntos, target_crs)

app <- ppp( x = st_coordinates(a_sf_reprojected)[,1],
            y = st_coordinates(a_sf_reprojected)[,2],
            marks = c(1:3221),
            window = window)

plot(app)

#app<-rjitter(app, retry = TRUE, nsim = 1, drop = TRUE)

unique(app)
unique(app, rule="deldir")
options(repr.plot.width = 50, repr.plot.height = 30)
plot(quadratcount(app, nx = 17, ny = 18))
quadrat.test(app, nx = 17, ny = 18)
```


```{r}

#Estimaciones de sigma 
estimacion1<-bw.diggle(app)
estimacion2<-bw.ppl(app)
estimacion3<-bw.scott(app)
plot(density.ppp(app,sigma = estimacion1,edge = T),main=paste("Diggle"))
plot(density.ppp(app,sigma = estimacion2,edge = T),main=paste("LH-crossvalidation"))
plot(density.ppp(app,sigma = estimacion3[1],edge = T),main=paste("Scott1"))
plot(density.ppp(app,sigma = estimacion3[2],edge = T),main=paste("Scott2"))
estimacion3[1]
estimacion3[2]
```



```{r}
#auxiliar<-st_union(calles_distrito1)
#plot(auxiliar)
red_vial_ln<- as_sfnetwork(calles_barrio)
plot(red_vial_ln)
calles_barrio <- st_transform(calles_barrio, crs = "+proj=utm +zone=30 +datum=WGS84")
puntos_barrio <- st_transform(puntos_barrio, crs = "+proj=utm +zone=30 +datum=WGS84")
red_vial_ln <- st_transform(red_vial_ln, crs = "+proj=utm +zone=30 +datum=WGS84")
red_vial_ln <- as.linnet(red_vial_ln)
lpp_VALE <- lpp(app,red_vial_ln)
#plot(lpp_VALE)
#lambdahat <- density.lpp(lpp_VALE,sigma = 150,distance = "euclidean",continuous = TRUE,kernel = "gaussian" )
#plot(lambdahat)

lambda <- density.lpp(lpp_VALE,sigma = 77.26966 ,distance = "euclidean")
plot(lambda)
lpp_VALE<-unmark(lpp_VALE)
m1<-lppm(lpp_VALE ~ 1)
r <- seq(0, 300, by=20)
k_finom<-linearKinhom(lpp_VALE,lambda = m1,r)
plot(k_finom)
plot(lpp_VALE)
#plot(red_vial_ln)
```


```{r}

EIP <- predict(m1)
#plot(EIP)

 # Matern cluster process on a linear network
 # Centers = (x,y)-coordinates of parent points
 # R = The R parameter of the Matern cluster process
 # alpha = The alpha parameter of the Matern cluster process
 # LL = The linear network on which the point pattern should be simulated.
rMatClustlpp <- function(Centers, R, alpha, LL) {
X <- array(0,0)
Y <- array(0,0)
for(p in 1:length(Centers$data$x)) {
BBCOutD <- disc(radius=R, centre=c(Centers$data$x[p],
Centers$data$y[p]),
npoly = 32)
BBCD <- intersect.owin(LL$window, BBCOutD)
if(volume(LL[BBCOutD])>0) {
Xp <- rpoislpp(alpha/volume(LL[BBCOutD]), L=LL[BBCD])
X <- append(X, as.numeric(Xp$data$x))
Y <- append(Y, as.numeric(Xp$data$y))
}
}
lpp(cbind(X,Y), LL)
}
```



```{r}
nsim <- 10
valpha <- seq(5, 30, by=6)
vR <- seq(100, 1000, by=350)

```


```{r}
set.seed(2023)
Contrast <- array(0, c(length(valpha), length(vR)))
for(i in 1:length(valpha)) {
  for(j in 1:length(vR)) {
  # Compute the average K of 10 simulation from the model
  KMC <- array(0,length(r))
  for(s in 1:nsim) {
  # Centers from a Poisson process
  Centers <- rpoislpp(EIP/valpha[i], L=lpp_VALE[['domain']])
  XX <- rMatClustlpp(Centers, vR[j], valpha[i], lpp_VALE[['domain']])
  KMC <- KMC + linearKinhom(XX, lambda = m1, r=r)$est
  }
  # Compute the difference between estimated and average K
  Contrast[i,j] <- sqrt(sum((k_finom$est-KMC/nsim)^2))
  }
}

```


```{r}
 plot(as.im(Contrast), main="Values of Contrasts")
 # Finding the minimum value of the contrast
 id <- which(Contrast == min(Contrast), arr.ind = TRUE)
 alpha <- valpha[id[,1]]
 R <- vR[id[,2]]
 # Chosen values

```


```{r}
# Centers from a Poisson process
Centers <- rpoislpp(EIP/alpha, L=lpp_VALE[['domain']])
par(mfrow=c(1,2))
plot(Centers)
XX <- rMatClustlpp(Centers, R, alpha, lpp_VALE[['domain']])
plot(XX, main="A realization of the model")
```
```{r}
atm_distancia <- puntos_barrio$atm_dist
police_distancia <- puntos_barrio$police_dist
bar_distancia <- puntos_barrio$bar_dist

atm_dist_imagen <- as.im(as.matrix(atm_distancia), W = Window(app))
police_dist_imagen <- as.im(as.matrix(police_distancia), W = Window(app))
bar_dist_imagen <- as.im(as.matrix(bar_distancia), W = Window(app))
m1<-lppm(lpp_VALE ~ atm_dist_imagen+police_dist_imagen+bar_dist_imagen)
r <- seq(0, 300, by=30)
k_finom<-linearKinhom(lpp_VALE,lambda = m1,r)
plot(k_finom)
```

```{r warning=FALSE}
set.seed(2023)
Contrast <- array(0, c(length(valpha), length(vR)))
for(i in 1:length(valpha)) {
  for(j in 1:length(vR)) {
  # Compute the average K of 10 simulation from the model
  KMC <- array(0,length(r))
  for(s in 1:nsim) {
  # Centers from a Poisson process
  Centers <- rpoislpp(EIP/valpha[i], L=lpp_VALE[['domain']])
  XX <- rMatClustlpp(Centers, vR[j], valpha[i], lpp_VALE[['domain']])
  KMC <- KMC + linearKinhom(XX, lambda = m1, r=r)$est
  }
  # Compute the difference between estimated and average K
  Contrast[i,j] <- sqrt(sum((k_finom$est-KMC/nsim)^2))
  }
}

```

```{r}
 plot(as.im(Contrast), main="Values of Contrasts")
 # Finding the minimum value of the contrast
 id <- which(Contrast == min(Contrast), arr.ind = TRUE)
 alpha <- valpha[id[,1]]
 R <- vR[id[,2]]
 # Chosen values

```

```{r}
# Centers from a Poisson process
Centers <- rpoislpp(EIP/alpha, L=lpp_VALE[['domain']])
par(mfrow=c(1,2))
plot(Centers)
XX <- rMatClustlpp(Centers, R, alpha, lpp_VALE[['domain']])
plot(XX, main="A realization of the model")
```